
import { GoogleGenAI, Type } from "@google/genai";
import { PatentCase, AuditResult } from "../types";

const SYSTEM_INSTRUCTION = `# SYSTEM ROLE
You are a Senior Patent Quality Auditor and Expert Patent Attorney with 20+ years of experience in patent prosecution. Your task is to evaluate the performance of an AI tool ("IPauthor") by comparing its proposed strategies against the actual successful outcome of the patent application (the "Granted Claims").

# GOAL
Determine if the strategies generated by IPauthor were sufficient to overcome the rejections and achieve the Granted Claims. You must evaluate if the tool predicted the "winning move."

# EVALUATION METHODOLOGY
Follow these steps strictly:

## Step 1: The "Delta" Analysis (Ground Truth)
Compare the Original Claims against the Granted Claims. Identify exactly what changed. This is the "Winning Amendment."

## Step 2: Strategy Matching (The Audit)
Review the IPauthor Generated Strategies.
- Check for Direct Matches.
- Check for Combinations.
- Check for Concept Matches.

## Step 3: Specification Verification
If the "Winning Amendment" came from the Specification: Verify if the IPauthor strategies successfully identified this specific paragraph/concept.

# SCORING CRITERIA (0-100)
- 100: Exact match or rewriting a suggested dependent claim.
- 85-99: Correct feature/concept identified, slight wording difference.
- 70-84: Correct area of novelty identified but different specific limitation.
- 50-69: Tool found a valid strategy, but attorney chose a different path.
- 0-49: Granted claims rely on a feature the tool completely ignored.

Output ONLY valid JSON matching the requested schema.`;

export async function auditSingleCase(caseData: PatentCase): Promise<AuditResult> {
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  
  const prompt = `
# DATA INPUTS
1. **Original Claims:** 
${caseData.originalClaims}

2. **Office Action Summary:**
${caseData.officeActionSummary}

3. **IPauthor Generated Strategies:**
${caseData.generatedStrategies}

4. **Application Specification:**
${caseData.specification || "Not provided in this batch."}

5. **Granted Claims:**
${caseData.grantedClaims || "NO GRANTED CLAIMS FOUND IN GROUND TRUTH CSV."}

Perform the audit for Application Number: ${caseData.appNumber}`;

  const response = await ai.models.generateContent({
    model: "gemini-3-pro-preview",
    contents: prompt,
    config: {
      systemInstruction: SYSTEM_INSTRUCTION,
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          evaluation_result: {
            type: Type.OBJECT,
            properties: {
              winning_amendment: {
                type: Type.OBJECT,
                properties: {
                  summary: { type: Type.STRING },
                  source_type: { type: Type.STRING },
                  source_details: { type: Type.STRING }
                },
                required: ["summary", "source_type", "source_details"]
              },
              strategy_evaluation: {
                type: Type.OBJECT,
                properties: {
                  best_matching_strategy_name: { type: Type.STRING },
                  prediction_accuracy: { type: Type.STRING },
                  match_analysis: { type: Type.STRING }
                },
                required: ["best_matching_strategy_name", "prediction_accuracy", "match_analysis"]
              },
              final_score: { type: Type.NUMBER },
              auditor_reasoning: { type: Type.STRING }
            },
            required: ["winning_amendment", "strategy_evaluation", "final_score", "auditor_reasoning"]
          }
        },
        required: ["evaluation_result"]
      }
    }
  });

  const parsed = JSON.parse(response.text || "{}");
  const result = parsed.evaluation_result;
  
  // ROI Logic: Score >= 70 is effective
  const avoided = (result?.final_score || 0) >= 70;
  
  return {
    appNumber: caseData.appNumber,
    evaluation_result: result,
    roi_metrics: {
      cost_saved: avoided ? 4500 : 0,
      hours_saved: avoided ? 15 : 0,
      avoided_second_oa: avoided
    }
  };
}
