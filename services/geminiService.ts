
import { GoogleGenAI, Type } from "@google/genai";
import { PatentCase, AuditResult } from "../types.ts";

const SYSTEM_INSTRUCTION = `# SYSTEM ROLE
You are a Senior Patent Quality Auditor and Expert Patent Attorney with 20+ years of experience in patent prosecution. Your task is to evaluate the performance of an AI tool ("IPauthor") by comparing its proposed strategies against the actual successful outcome of the patent application (the "Granted Claims").

# GOAL
Determine if the strategies generated by IPauthor were sufficient to overcome the rejections and achieve the Granted Claims. You must evaluate if the tool predicted the "winning move."

# EVALUATION METHODOLOGY
1. **Step 1: The "Delta" Analysis (Ground Truth)**
   Compare the Original Claims against the Granted Claims. Identify exactly what changed. This change is the "Winning Amendment."

2. **Step 2: Strategy Matching (The Audit)**
   Review the IPauthor Generated Strategies. Check for Direct Matches, Combinations, or Concept Matches.

3. **Step 3: Specification Verification**
   If the "Winning Amendment" came from the Specification, verify if IPauthor strategies successfully identified this specific paragraph/concept.

# SCORING CRITERIA (0-100)
* **100 (Perfect):** Explicit recommendation of exact amendment used.
* **85-99 (Excellent):** Correct feature or concept, slightly different wording.
* **70-84 (Good):** Identified correct area of novelty but proposed different specific limitation.
* **50-69 (Partial):** Found valid strategy, but attorney chose a different path.
* **0-49 (Failure):** Tool ignored or failed to extract the winning feature from the Specification.

# OUTPUT
You must return a structured JSON response strictly following the evaluation results schema.`;

export async function auditSingleCase(caseData: PatentCase): Promise<AuditResult> {
  // Always create a new instance right before use to ensure the most up-to-date API key is used.
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  
  const prompt = `
# AUDIT DATA INPUTS
1. ORIGINAL CLAIMS:
${caseData.originalClaims}

2. OFFICE ACTION SUMMARY:
${caseData.officeActionSummary}

3. IPAUTHOR GENERATED STRATEGIES:
${caseData.generatedStrategies}

4. APPLICATION SPECIFICATION:
${caseData.specification}

5. GRANTED CLAIMS (The Ground Truth):
${caseData.grantedClaims}

# TASK
Perform the Delta Audit for App Number: ${caseData.appNumber}.`;

  const response = await ai.models.generateContent({
    model: "gemini-3-pro-preview",
    contents: prompt,
    config: {
      systemInstruction: SYSTEM_INSTRUCTION,
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          evaluation_result: {
            type: Type.OBJECT,
            properties: {
              winning_amendment: {
                type: Type.OBJECT,
                properties: {
                  summary: { type: Type.STRING },
                  source_type: { type: Type.STRING },
                  source_details: { type: Type.STRING }
                },
                required: ["summary", "source_type", "source_details"]
              },
              strategy_evaluation: {
                type: Type.OBJECT,
                properties: {
                  best_matching_strategy_name: { type: Type.STRING },
                  prediction_accuracy: { type: Type.STRING },
                  match_analysis: { type: Type.STRING }
                },
                required: ["best_matching_strategy_name", "prediction_accuracy", "match_analysis"]
              },
              final_score: { type: Type.NUMBER },
              auditor_reasoning: { type: Type.STRING }
            },
            required: ["winning_amendment", "strategy_evaluation", "final_score", "auditor_reasoning"]
          }
        },
        required: ["evaluation_result"]
      }
    }
  });

  const text = response.text;
  if (!text) {
    throw new Error("No response text received from the evaluation model.");
  }
  
  const parsed = JSON.parse(text);
  const result = parsed.evaluation_result;
  const avoided = (result?.final_score || 0) >= 70;
  
  return {
    appNumber: caseData.appNumber,
    evaluation_result: result,
    roi_metrics: {
      cost_saved: avoided ? 4500 : 0,
      hours_saved: avoided ? 15 : 0,
      avoided_second_oa: avoided
    }
  };
}
